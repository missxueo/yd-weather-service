# 应用架构思想

## 模块

### 1.业务设计

* 地区

管理地区

* 天气信息
  * 实时天气记录
  * 天气预测记录

### 2. 两个主模块:

* 公共模块`CommonModule`

导入TypeOrmModule 等等 全局依赖包

* 业务模块`MainModule`

管理业务模块入口及服务

## 程序设计

### 1. 缓存设计

请求过程中的两种缓存：

* 采用请求响应缓存，缓存5s,避免相同请求频繁进入程序。
* 进入程序后，分以下几个步骤：
  1. 检查缓存是否存在，如果键能检索到值，则返回；
  2. 使用redlock根据`areaCode`加锁；
  3. 重复1操作，检查缓存，不存在则执行下一步。
  4. 去数据库检索数据，无论存在不存在都将数据加入缓存；
  5. 释放redlock锁；

此处通过redlock来保证，一个areaCode同时只能有一次数据库操作。

在更新天气数据的时候，将实时天气数据同步缓存到redis中。

### 2. 同步数据

使用Cron 定时任务来触发同步远端数据。

* 在Cron任务中，生成根据areaCode加载数据的子任务，并添加到`bull`队列任务中。
* 由队列调度器去调度，按批次从队列中弹出去执行同步任务。
* 加载数据后，经过数据适配，使用`cqrs`模式，将数据发送到命令中，并由命令的执行者去缓存并保存数据。

### 3. 文档

使用 集成的 swagger 生成了对应的文档，并进行了简单的描述

地址: http://localhost:3000/api

### 4. 数据库

数据库脚本放置于`sql`文件夹下

## 其它

忽略了一些设计；

1. 根据`经纬度`来获取地区的接口，这个需要第三方接口或数据。
2. 可能的字典数据，对字典的管理。
3. rate limiter， 交给反向代理nginx 或 bff层来做更合理。


